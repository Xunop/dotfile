#!/bin/sh

#echo 7 > /sys/devices/pci0000:00/0000:00:02.0/sriov_numvfs
#modprobe vfio
#modprobe vfio_pci
#echo "0000:00:02.1" > /sys/devices/pci0000:00/0000:00:02.1/driver/unbind
#echo "0000:00:02.1" > /sys/bus/pci/drivers/vfio-pci/bind

img_path=/home/xun/Workspace/qemu_conf/qemu_img/WindowsVM.img
iso=/home/xun/Workspace/qemu_conf/iso/cn_windows_10_multi-edition_vl_version_1709_updated_dec_2017_x64_dvd_100406208.iso
vi_iso=/home/xun/Workspace/qemu_conf/iso/virtio-win-0.1.229.iso

qemu-system-x86_64 -drive file=$img_path,format=qcow2,if=virtio \
  -drive file=$iso,media=cdrom \
  -drive file=$vi_iso,media=cdrom \
  -boot order=d \
  -audiodev pa,id=pa1 \
  -device ich9-intel-hda,id=sound0,bus=pcie.0,addr=0x1b \
  -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0,audiodev=pa1 \
  -global ICH9-LPC.disable_s3=1 -global ICH9-LPC.disable_s4=1 \
  -device qemu-xhci \
  -device usb-tablet \
  -enable-kvm \
  -machine type=q35,kernel-irqchip=split \
  -cpu host,hv_relaxed,hv_spinlocks=0x1fff,hv_time,hv_vapic,hv_vendor_id=GenuineIntel,kvm=off,hypervisor,migratable=on,+invtsc \
  -rtc clock=host,base=localtime \
  -m 8G \
  -smp sockets=1,cores=6,threads=2 \
  -net nic, -net user,hostname=windows \
  -vga virtio \
  -device intel-iommu,intremap=on,caching-mode=on \
  -device vfio-pci,host=00:02.1,multifunction=on \
  -monitor stdio \
  -device usb-host,vendorid=0x1a40,productid=0x0801 \
  -display sdl,gl=on -name "Windows 10 1709 64 bit" 
  
#-net nic, -net user,hostname=windows,hostfwd=tcp::47984-:47984,hostfwd=tcp::47989-:47989,hostfwd=tcp::48010-:48010,hostfwd=udp::47998-:47998,hostfwd=udp::47999-:47999,hostfwd=udp::48000-:48000,hostfwd=udp::48002-:48002,hostfwd=udp::48010-:48010 \
#> /home/xun/Workspace/qemu_conf/log/windows.log 2>&1 &
#-monitor stdio \
